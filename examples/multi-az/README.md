# Wireguard multi AZ deployment
This setup provides high availability within a single AWS region, utilizing multiple availability zones.

## Design
![Wireguard Multi AZ design](./../../docs/aws-wireguard-multi-az-no-app.svg)

### Clients connections
Multiple EC2 instances are spread across several availability zones within a region. Clients connections get distributed to the instances through highly-available Network Load Balancer with Route53 DNS record attached (optional).

### Configuration changes
Wireguard configuration file is being generated by Terraform and stored in S3 bucket with enabled versioning and access logs. Every S3 bucket content change triggers Lambda function through SQS queue. Lambda function executes predefined SSM document on all Wireguard EC2 instances. SSM document is configured to upload the latest configuration file to the instances and reload Wireguard interface.
Also, Wireguard instances have PreUp hook enabled which additionally ensures that they use the latest configuration file available in S3.

## Quick start
The code supports both `terraform` and `terragrunt`. In case of pure `terraform` state file will be stored locally but if you prefer `teragrant`, S3 bucket for the state will be created automatically on your behalf.

### Set variables
Please, review defined variables under `terraform.tvars` file. For simplicity, this example doesn't redefine all defaults provided by the module.
The whole list of available variables is presented in module [README.md](./../../README.md) file.

#### Wireguard clients
Wireguard clients are managed by `wg_peers` variable. Example:
```hcl
wg_peers = {
  user-1 = {
    public_key      = "dRWcZBv2++23GZ0DdoFLrXvGch4lcZ2Fj7yeaSAUB2I="
    peer_ip         = "10.0.44.2/32"
    allowed_subnets = ["10.0.44.0/24", "8.8.8.8/32"]
    isolated        = true
  }
  user-2 = {
    public_key      = ""
    peer_ip         = "10.0.44.3/32"
    allowed_subnets = ["10.0.44.0/24", "8.8.8.8/32"]
    isolated        = true
  }
}
```
* `public_key` — peer public key. It is optional and will be automatically generated if empty string passed.
* `peer_ip` — peer IP-address or subnet in CIDR notation. Must be within `wg_cidr` range.
* `allowed_subnets` — controls what subnets peer will be able to access through Wireguard network (for bounce server mode set to `0.0.0.0/0`).
* `isolated` — if `true` peer won't be able to access other Wireguard peers.

If you already have Wireguard installed, you may generate all the keys yourself and pass them through variables:
```shell
umask 077 ; wg genkey > privatekey ; wg pubkey < privatekey > publickey
```

#### DNS
If your target DNS zone is managed by Route53, this code may create a DNS record for Wireguard endpoint for you.
Make sure that you define your domain zone name in `dns_zone_name` variable in `terraform.tfvars` file.
This is optional, if that variable is omitted or empty string passed, the code will skip Route53 resources.

#### SSH key pair
Please, define your SSH public key in `ec2_ssh_public_key` variable. That key will be used for EC2 instances.

### AWS connection
Before running the code, make sure that your AWS connection is working.
```shell
aws sts get-caller-identity
```
If you're using `aws-vault` tool, see examples below.

### Deploy Wireguard server
Several ways of deployment will be presented below. Please, choose the one which fits your needs best.
Before proceeding make sure that `AWS_REGION` variable is set correctly.
```shell
export AWS_REGION=<YOUR REGION>
```
#### Terragrunt how-to
```shell
cd examples/multi-az
terragrunt init
terragrunt plan
terragrunt apply

# get wireguard keys after deployment
terragrunt output wireguard_keys

# get wireguard client configuration files after deployment
terragrunt output wireguard_client_configs
```

#### Terragrunt with aws-vault how-to
```shell
cd examples/multi-az
aws-vault exec $AWS_PROFILE --no-session  -- terragrunt init
aws-vault exec $AWS_PROFILE --no-session  -- terragrunt plan
aws-vault exec $AWS_PROFILE --no-session  -- terragrunt apply

# get wireguard keys after deployment
aws-vault exec $AWS_PROFILE --no-session  -- terragrunt output wireguard_keys

# get wireguard client configuration files after deployment
aws-vault exec $AWS_PROFILE --no-session  -- terragrunt output wireguard_client_configs
```

#### Terraform how-to
```shell
cd examples/multi-az
terraform init
terraform plan
terraform apply

# get wireguard keys after deployment
terraform output wireguard_keys

# get wireguard client configuration files after deployment
terraform output wireguard_client_configs
```

#### Terraform with aws-vault how-to
```shell
cd examples/multi-az
aws-vault exec $AWS_PROFILE --no-session  -- terraform init
aws-vault exec $AWS_PROFILE --no-session  -- terraform plan
aws-vault exec $AWS_PROFILE --no-session  -- terraform apply

# get wireguard keys after deployment
aws-vault exec $AWS_PROFILE --no-session  -- terraform output wireguard_keys

# get wireguard client configuration files after deployment
aws-vault exec $AWS_PROFILE --no-session  -- terraform output wireguard_client_configs
```

## Contribute
Any reasonable pull requests are always welcomed. All PRs are subject to automated checks, so please make sure that your changes pass all configured [pre-commit](https://pre-commit.com/) hooks.
If you found a bug or need support of any kind, please start a new conversation in [Issues](https://github.com/Globaldots/tf-wireguard-server/issues) section. 

## License
The code is licensed under GNU GPL [license](./../../LICENSE).
